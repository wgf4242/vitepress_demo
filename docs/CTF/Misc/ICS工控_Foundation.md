# Mosbus
Modbus 协议解析, 例 `2356000000060106000126cd`

写单个线圈

| Code  | Description                   |
| ----- | ----------------------------- |
| 23 56 | Transaction Identifier 随机值 |
| 00 00 | Protocol Identifier           |
| 00 06 | Length                        |
| 1     | Unit Identifier 自定义值      |
| 6     | Function Code                 |
| 00 01 | Reference Number:地址         |
| 26 CD | Word Count: 读取数量(bit)     |

写多个线圈: 从3号地址 开启3,4,6,7号灯 `00 00 00 00 00 08 01 0F 00 03 00 05 01 1B`

以及`MODBUS RTU`常用的功能码：

| 功能码    | 含义         |
| :-------- | :----------- |
| 01 (0x01) | 读线圈       |
| 02 (0x02) | 读离散量输入 |
| 03 (0x03) | 读保持寄存器 |
| 04 (0x04) | 读输入寄存器 |
| 05 (0x05) | 写单个线圈   |
| 06 (0x06) | 写单个寄存器 |
| 15 (0x0F) | 写多个线圈   |
| 16 (0x10) | 写多个寄存器 |

| 说明       | 16进制 |
| ---------- | ------ |
| 传输标识   | 00 00  |
| 协议标识   | 00 00  |
| 长度       | 00 08  |
| 站号       | 01     |
| 功能码     | 0F     |
| 起始地址   | 00 03  |
| 写入数量   | 00 05  |
| 占用字节数 | 01     |
| 写入输出   | 1B     |

上面的1B对应值 `11011`
| 灯号   | 7    | 6    | 5    | 4    | 3    |
| ------ | ---- | ---- | ---- | ---- | ---- |
| 二进制 | 1    | 1    | 0    | 1    | 1    |


功能码介绍

| Size | Desc     | Code   | Desc                           |
| ---- | -------- | ------ | ------------------------------ |
| 1B   | 功能码   | 1      | 读DO                           |
|      |          | 3      | AO 转速/阀门开度/角度 π:180度  |
|      |          | 05 15  | 05 DI 写入单个数字量 15写多个  |
|      |          | 06 16  | 06 AI 写入模拟量               |
| 2B   | 地址     | 00 00  | 从00 00 位置                   |
| 2B   | 读取数量 | 00 03  | 读3个线圈 3bit                 |

DI/DO: Discrete Outputs/Inputs

| 数字量               |      |                            |
| -------------------- | ---- | -------------------------- |
|                      | DO   | 可读写                     |
|                      | DI   | 外部变量，只读             |
| 模拟量:每个占2字节   |      |                            |
|                      | AI   | 借助外力                   |
|                      | AO   | 不需要外力 PLC可控制的为AO |

MODBUS 请求包 5字节

| Size | Desc          | Code     | Desc                   |
| ---- | ------------- | -------- | ---------------------- |
| 1B   | 功能码        |          | 读DO                   |
| 1B   | 分配空间Bytes | 1        | 1字节 3bit不够1B分配1B |
| 1B   | 实际数值      | bit 0:1  | 0b101即5               |
|      |               | bit 1:0  |                        |
|      |               | bit 2:1  |                        |

```
1.小王先要从0x0002地址读取5个线圈的状态，请试着用modbus协议组包 

2.小李想要获取0x0123处3个行程开关的状态，请试着用modbus协议组包
de ad 00 00 00 06   01 01 01 23 00 03

3.小强想要读取0x0546处6个电机的转速状态
00 00 00 00 00 06   01 03 05 46 00 06 

4.小方想要获取0x1235处8个电表的数值，请试着用modbus协议组包
9527 0000 0006 0104 1235 0008 
0001 0000 0006 0104 1235 0008 
```

2.功能码为预置(写入)单个寄存器,请求把从机设备20中的40020寄存器预置为0003H值?

地址指的是Unit Identifier: 1, 通常为1 。机架号、厂房号、设备号。

| 地址 | 功能码 | 寄存器地址高位(转16h) | 寄存器地址低位(转16h) | 数据高位 | 数据低位 |
| ---- | ------ | --------------------- | --------------------- | -------- | -------- |
| 13   | 06     | 00                    | 13                    | 00       | 03       |

地址是从0开始。设备号从1开始。PC机1号。外部设备从2开始。

| 提示     | 解题                             |
| -------- | -------------------------------- |
| 设备号20 | 地址从0算 20-1=14h-1=13h         |
| 寄存器   | 模拟量A                          |
| 单个写入 | 功能码:06                        |
| 40020    | 4->AO见 `寄存器地址分配`.        |
| 0020     | 第2个地址 <br> 0020=0014h=14h-1=13|

修改设备状态 开启/关闭, 未给地址时00 00 或 00 01
给了地址比如 173 转hex即 00 ac

| Status | 状态码 | Desc          |
| ------ | ------ | ------------- |
| On     | ff 00  | 实际写入后为1 |
| Off    | 00 00  |               |

Modbus 寄存器地址分配

| 寄存器PLC地址 | 寄存器MODBUS 协议地址 | 适用功能    | 寄存器种类     | 读写状态 |
| ------------- | --------------------- | ----------- | -------------- | -------- |
| 00001-09999   | 0000H-FFFFH           | 01H 05H OFH | 线圈状态DO     | 可读可写 |
| 10001-19999   | 0000H-FFFFH           | 02H         | 离散输入状态DI | 只读     |
| 30001-39999   | 0000H-FFFFH           | 04H         | 输入寄存器AI   | 只读     |
| 40001-49999   | 0000H-FFFFH           | 03H 06H 10H | 保持寄存器AO   | 可读可写 |

首位0、1、3、4对应的DI,DO,AI,DO
## MX地址计算
%MW0.0-%MW0.100 的地址是多少
%MX0.0.0-%mx0.100.7的地址是多少

| name       | addr  |
| ---------- | ----- |
| %MW0.0     | 40001 |
| %MW0.01    | 40002 |
| %MW0.100   | 40101 |
| %MX0.0.0   | 1     |
| %MX0.0.1   | 2     |
| %MX0.100.7 | 808   |
## 相关工具
modscan

# s7comm

s7comm.data.returncode == 00  返回代码
s7comm.param.func  == 05      Write Var
s7comm.param.func == 0x28     控制信息

| func | Description                  |
| ---- | ---------------------------- |
| 0x00 | CPU services CPU服务         |
| 0xf0 | Setup communication 建立通信 |
| 0x04 | Read Var 读取值              |
| 0x05 | Write Var 写入值             |
| 0x1a | Request download 请求下载    |
| 0x1b | Download block 下载块        |
| 0x1c | Download ended 下载结束      |
| 0x1d | Start upload 开始上传        |
| 0x1e | Upload 上传                  |
| 0x1f | End upload 上传结束          |
| 0x28 | PI-Service 程序调用服务      |
| 0x29 | PLC Stop 关闭PLC             |

s7comm.data.returncode

> 00 无法确认是否成功
> 01 硬件错误
> 0xff 正常

# mms
mms.itemId == "LLN0$CO$FunEna2$Oper"

https://mp.weixin.qq.com/s/rpl-hmPZRazP2Y5B7iXDsQ

# 工控ICS/软件下载
```sh
https://pan.baidu.com/s/13pz6rQVn_ZM5utXeaKiW8Q#fer7
SIMATIC_WinCC_Legacy_Panel_Images
SIMATIC_WinCC_Panel_Images_V17
TIA_Portal_STEP7_Prof_Safety_WINCC_Adv_Unified_V17
TIA_Portal_STEP7_Prof_Safety_WINCC_DVD_2_V17
AutoThink https://www.hollysys.com/cn/other/download.html
```